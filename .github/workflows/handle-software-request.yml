name: Handle Software Request

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write
  models: read

jobs:
  process-software-request:
    if: contains(github.event.issue.labels.*.name, 'software-request')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Extract software name from issue
        id: extract
        run: |
          # Extract software name from issue title
          ISSUE_TITLE="${{ github.event.issue.title }}"
          # Remove prefix like "[è½¯ä»¶ç”³è¯·]" or "[Software Request]"
          SOFTWARE_NAME=$(echo "$ISSUE_TITLE" | sed -E 's/^\[.*\]\s*//')
          echo "software_name=$SOFTWARE_NAME" >> $GITHUB_OUTPUT
          
          # Extract additional info from issue body if present
          ISSUE_BODY="${{ github.event.issue.body }}"
          echo "issue_body<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on issue - Processing started
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ¤– GitHub Copilot Agent has been started and is searching for information about **${{ steps.extract.outputs.software_name }}**...

**Progress** / **è¿›åº¦**:
- âœ… Request received / ç”³è¯·å·²æ¥æ”¶
- ğŸ”„ Searching for official website and download address / æ­£åœ¨æœç´¢å®˜æ–¹ç½‘ç«™å’Œä¸‹è½½åœ°å€
- â³ Waiting to create resource files / ç­‰å¾…åˆ›å»ºèµ„æºæ–‡ä»¶
- â³ Waiting for manual review / ç­‰å¾…äººå·¥å®¡æ ¸

Please be patient. This issue will be automatically updated when processing is complete.
è¯·è€å¿ƒç­‰å¾…ï¼Œå¤„ç†å®Œæˆåä¼šè‡ªåŠ¨æ›´æ–°æ­¤ Issueã€‚`
            });

      - name: Create agent instruction in repository
        run: |
          mkdir -p .github/agent-instructions
          cat > .github/agent-instructions/software-request-${{ github.event.issue.number }}.md << 'EOF'
          # è½¯ä»¶èµ„æºæœç´¢å’Œåˆ›å»ºä»»åŠ¡
          
          ## ä»»åŠ¡ç›®æ ‡
          
          ä¸ºç”¨æˆ·ç”³è¯·çš„è½¯ä»¶åˆ›å»ºå®Œæ•´çš„ä¸‹è½½èµ„æºï¼ŒåŒ…æ‹¬ï¼š
          1. æœç´¢è½¯ä»¶çš„å®˜æ–¹ç½‘ç«™å’Œä¸‹è½½åœ°å€
          2. åˆ›å»ºç¬¦åˆé¡¹ç›®è§„èŒƒçš„ç›®å½•ç»“æ„
          3. ç¼–å†™ä¸­è‹±æ–‡è½¯ä»¶æè¿°æ–‡ä»¶
          4. é…ç½®ä¸‹è½½æ–¹å¼ï¼ˆå®˜ç½‘ä¸‹è½½ä¼˜å…ˆï¼‰
          
          ## è½¯ä»¶ä¿¡æ¯
          
          **è½¯ä»¶åç§°**: ${{ steps.extract.outputs.software_name }}
          
          **ç”¨æˆ·è¡¥å……è¯´æ˜**:
          ${{ steps.extract.outputs.issue_body }}
          
          ## é¡¹ç›®è§„èŒƒ
          
          ### ç›®å½•ç»“æ„
          
          åœ¨ `down/` ç›®å½•ä¸‹åˆ›å»ºä»¥ä¸‹ç»“æ„ï¼š
          
          ```
          down/
          â””â”€â”€ {è½¯ä»¶åç§°}/
              â”œâ”€â”€ readme.md         # ä¸­æ–‡è½¯ä»¶æè¿°
              â”œâ”€â”€ readme.en.md      # è‹±æ–‡è½¯ä»¶æè¿°
              â”œâ”€â”€ tags.txt          # è½¯ä»¶åˆ†ç±»æ ‡ç­¾ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰
              â””â”€â”€ latest/           # ç‰ˆæœ¬ç›®å½•
                  â”œâ”€â”€ readme.md     # ç‰ˆæœ¬è¯´æ˜ï¼ˆå¯é€‰ï¼‰
                  â”œâ”€â”€ link.txt      # å®˜ç½‘ä¸‹è½½é“¾æ¥ï¼ˆé¦–é€‰ï¼‰
                  â””â”€â”€ [files]       # æˆ–ç›´æ¥ä¸‹è½½æ–‡ä»¶
          ```
          
          ### ä¸‹è½½æ–¹å¼ä¼˜å…ˆçº§
          
          1. **å®˜ç½‘ä¸‹è½½ï¼ˆé¦–é€‰ï¼‰**: åˆ›å»º `link.txt` æ–‡ä»¶ï¼Œå†…å®¹ä¸ºå®˜æ–¹ä¸‹è½½é¡µé¢çš„ URL
          2. **P2P ä¸‹è½½**: å¦‚æœæœ‰ç£åŠ›é“¾æ¥ï¼Œåˆ›å»º `link.txt`ï¼Œå†…å®¹ä»¥ `magnet:` å¼€å¤´
          3. **ç›´æ¥ä¸‹è½½**: åªæœ‰åœ¨æ— æ³•è·å–å®˜ç½‘é“¾æ¥æ—¶æ‰è€ƒè™‘
          
          ### è½¯ä»¶æè¿°è¦æ±‚ (readme.md)
          
          åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š
          - è½¯ä»¶çš„ç®€è¦ä»‹ç»ï¼ˆ1-2 æ®µï¼‰
          - ä¸»è¦ç‰¹æ€§ï¼ˆåˆ—è¡¨å½¢å¼ï¼Œ3-5 ä¸ªè¦ç‚¹ï¼‰
          - å®˜æ–¹ç½‘ç«™é“¾æ¥
          - ç³»ç»Ÿè¦æ±‚ï¼ˆå¦‚æœæœ‰ï¼‰
          - è®¸å¯è¯ç±»å‹
          
          ### æ ‡ç­¾åˆ†ç±» (tags.txt)
          
          ä»ä»¥ä¸‹æ ‡ç­¾ä¸­é€‰æ‹©æœ€åˆé€‚çš„ 1-2 ä¸ªï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼š
          - `development` - å¼€å‘å·¥å…·
          - `office` - åŠå…¬è½¯ä»¶
          - `media` - åª’ä½“å·¥å…·
          - `system` - ç³»ç»Ÿå·¥å…·
          - `network` - ç½‘ç»œå·¥å…·
          - `security` - å®‰å…¨è½¯ä»¶
          - `game` - æ¸¸æˆå¨±ä¹
          - `other` - å…¶ä»–
          
          ## æ‰§è¡Œæ­¥éª¤
          
          1. **æœç´¢ä¿¡æ¯**
             - ä½¿ç”¨ web_search æœç´¢è½¯ä»¶çš„å®˜æ–¹ç½‘ç«™
             - ç¡®è®¤è½¯ä»¶çš„æ­£å¼åç§°
             - æ‰¾åˆ°å®˜æ–¹ä¸‹è½½é¡µé¢çš„ URL
          
          2. **åˆ›å»ºç›®å½•ç»“æ„**
             - åœ¨ `down/` ç›®å½•ä¸‹åˆ›å»ºè½¯ä»¶æ–‡ä»¶å¤¹
             - åˆ›å»º `latest` ç‰ˆæœ¬æ–‡ä»¶å¤¹
          
          3. **ç¼–å†™è½¯ä»¶æè¿°**
             - åˆ›å»º `readme.md`ï¼ˆä¸­æ–‡ï¼‰
             - åˆ›å»º `readme.en.md`ï¼ˆè‹±æ–‡ï¼‰
             - åŒ…å«è½¯ä»¶ä»‹ç»ã€ç‰¹æ€§ã€å®˜ç½‘é“¾æ¥ç­‰
          
          4. **é…ç½®ä¸‹è½½æ–¹å¼**
             - ä¼˜å…ˆåˆ›å»º `link.txt` åŒ…å«å®˜ç½‘ä¸‹è½½é“¾æ¥
             - ä¸è¦ä¸‹è½½æˆ–åŒ…å«å®é™…è½¯ä»¶æ–‡ä»¶
          
          5. **æ·»åŠ åˆ†ç±»æ ‡ç­¾**
             - åˆ›å»º `tags.txt` æ–‡ä»¶
             - æ ¹æ®è½¯ä»¶ç±»å‹é€‰æ‹©åˆé€‚çš„æ ‡ç­¾
          
          ## æ³¨æ„äº‹é¡¹
          
          - ç¡®ä¿æ‰€æœ‰æ–‡ä»¶ä½¿ç”¨ UTF-8 ç¼–ç 
          - Markdown æ–‡ä»¶ä½¿ç”¨æ ‡å‡†çš„ Markdown æ ¼å¼
          - é“¾æ¥å¿…é¡»æ˜¯æœ‰æ•ˆçš„ URL
          - ä¸è¦åŒ…å«ä»»ä½•å¹¿å‘Šæˆ–æ¨å¹¿å†…å®¹
          - æè¿°è¦å®¢è§‚ã€å‡†ç¡®ã€ç®€æ´
          - å¿…é¡»æ ‡æ³¨è½¯ä»¶çš„è®¸å¯è¯ç±»å‹
          
          ## å®Œæˆæ ‡å‡†
          
          - [ ] æˆåŠŸæœç´¢åˆ°è½¯ä»¶çš„å®˜æ–¹ç½‘ç«™
          - [ ] åˆ›å»ºäº†å®Œæ•´çš„ç›®å½•ç»“æ„
          - [ ] ç¼–å†™äº†ä¸­è‹±æ–‡æè¿°æ–‡ä»¶
          - [ ] é…ç½®äº†å®˜ç½‘ä¸‹è½½æ–¹å¼
          - [ ] æ·»åŠ äº†åˆé€‚çš„åˆ†ç±»æ ‡ç­¾
          - [ ] æ‰€æœ‰æ–‡ä»¶æ ¼å¼æ­£ç¡®ï¼Œå†…å®¹å‡†ç¡®
          
          å®Œæˆåï¼Œåˆ›å»ºä¸€ä¸ª Pull Requestï¼Œæ ‡é¢˜ä¸º "æ·»åŠ è½¯ä»¶: ${{ steps.extract.outputs.software_name }}"ï¼Œå¹¶åœ¨æè¿°ä¸­è¯´æ˜ï¼š
          - è½¯ä»¶çš„å®˜æ–¹ç½‘ç«™
          - ä¸‹è½½æ–¹å¼
          - ä¸»è¦ç‰¹æ€§
          - å…³è”çš„ Issue ç¼–å· (#${{ github.event.issue.number }})
          EOF
          
          echo "Agent instruction file created at .github/agent-instructions/software-request-${{ github.event.issue.number }}.md"

      - name: Trigger GitHub Copilot Agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create a new branch for the agent to work on
          BRANCH_NAME="software-request-${{ github.event.issue.number }}"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git checkout -b "$BRANCH_NAME"
          
          # Add the instruction file
          git add .github/agent-instructions/software-request-${{ github.event.issue.number }}.md
          
          # Create a placeholder file to initialize the branch
          mkdir -p "down/${{ steps.extract.outputs.software_name }}"
          echo "# ${{ steps.extract.outputs.software_name }}" > "down/${{ steps.extract.outputs.software_name }}/.agent-processing"
          echo "This directory is being processed by GitHub Copilot Agent." >> "down/${{ steps.extract.outputs.software_name }}/.agent-processing"
          echo "Issue: #${{ github.event.issue.number }}" >> "down/${{ steps.extract.outputs.software_name }}/.agent-processing"
          
          git add "down/${{ steps.extract.outputs.software_name }}/.agent-processing"
          git commit -m "chore: initialize processing for ${{ steps.extract.outputs.software_name }}"
          git push origin "$BRANCH_NAME"
          
          # Create a comment with manual instructions since GitHub Copilot Workspace integration
          # needs to be set up separately or done manually
          echo "Branch created: $BRANCH_NAME"

      - name: Comment on issue - Manual action required
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = `software-request-${{ github.event.issue.number }}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ“‹ Work branch created for this request: \`${branchName}\`

**Next Steps** / **ä¸‹ä¸€æ­¥æ“ä½œ**:

Since full automation of GitHub Copilot Agent requires additional configuration, administrators currently need to manually complete the following steps:

ç”±äº GitHub Copilot Agent çš„å®Œå…¨è‡ªåŠ¨åŒ–éœ€è¦é¢å¤–é…ç½®ï¼Œç›®å‰éœ€è¦ç®¡ç†å‘˜æ‰‹åŠ¨å®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š

1. Use GitHub Copilot to work on branch \`${branchName}\`
   ä½¿ç”¨ GitHub Copilot åœ¨åˆ†æ”¯ \`${branchName}\` ä¸Šå·¥ä½œ

2. Search and create resources according to the following requirements:
   æŒ‰ç…§ä»¥ä¸‹è¦æ±‚æœç´¢å¹¶åˆ›å»ºèµ„æºï¼š
   - Search for the official website of **${{ steps.extract.outputs.software_name }}**
     æœç´¢ **${{ steps.extract.outputs.software_name }}** çš„å®˜æ–¹ç½‘ç«™
   - Create resources in \`down/${{ steps.extract.outputs.software_name }}/latest/\` directory
     åœ¨ \`down/${{ steps.extract.outputs.software_name }}/latest/\` ç›®å½•åˆ›å»ºèµ„æº
   - Create \`readme.md\` and \`readme.en.md\` description files
     åˆ›å»º \`readme.md\` å’Œ \`readme.en.md\` æè¿°æ–‡ä»¶
   - Create \`link.txt\` containing the official download link
     åˆ›å»º \`link.txt\` åŒ…å«å®˜ç½‘ä¸‹è½½é“¾æ¥
   - Create \`tags.txt\` to add category tags
     åˆ›å»º \`tags.txt\` æ·»åŠ åˆ†ç±»æ ‡ç­¾

3. Create a Pull Request and link it to this Issue
   åˆ›å»º Pull Request å¹¶å…³è”æ­¤ Issue

**Or** / **æˆ–è€…**, refer to the detailed instructions in \`.github/agent-instructions/software-request-${{ github.event.issue.number }}.md\`
ç®¡ç†å‘˜å¯ä»¥å‚è€ƒ \`.github/agent-instructions/software-request-${{ github.event.issue.number }}.md\` ä¸­çš„è¯¦ç»†æŒ‡ä»¤ã€‚

---

**Alternative Solution** / **ä¸´æ—¶è§£å†³æ–¹æ¡ˆ**: Users can also manually create a Pull Request following the [project documentation](https://github.com/${context.repo.owner}/${context.repo.repo}#æ·»åŠ è½¯ä»¶).
åœ¨æœªé…ç½®è‡ªåŠ¨åŒ–ä¹‹å‰ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥ç›´æ¥æŒ‰ç…§ [é¡¹ç›®æ–‡æ¡£](https://github.com/${context.repo.owner}/${context.repo.repo}#æ·»åŠ è½¯ä»¶) æ‰‹åŠ¨åˆ›å»º Pull Requestã€‚`
            });

      - name: Add processing label
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['processing']
            });
