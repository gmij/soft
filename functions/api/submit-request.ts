/**
 * Cloudflare Pages Function to handle software request submissions
 * Creates GitHub issues automatically via GitHub API
 */

interface RequestBody {
  softwareName: string;
  additionalInfo?: string;
  language: 'zh-CN' | 'en';
}

interface Env {
  GITHUB_TOKEN: string;
}

export const onRequestPost: PagesFunction<Env> = async (context) => {
  const { request, env } = context;

  // CORS headers - restrict to actual domain in production
  const corsHeaders = {
    'Access-Control-Allow-Origin': '*', // TODO: Replace with actual domain in production
    'Access-Control-Allow-Methods': 'POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type',
  };

  // Handle CORS preflight
  if (request.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    // Parse request body
    let body: RequestBody;
    try {
      body = await request.json() as RequestBody;
    } catch (parseError) {
      return new Response(
        JSON.stringify({ 
          error: 'Invalid request format' 
        }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }
    
    // Validate input
    if (!body.softwareName || body.softwareName.trim().length === 0) {
      return new Response(
        JSON.stringify({ 
          error: body.language === 'en' 
            ? 'Software name is required' 
            : 'è½¯ä»¶åç§°ä¸èƒ½ä¸ºç©º' 
        }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    // Validate software name length (GitHub title limit is 256)
    if (body.softwareName.length > 200) {
      return new Response(
        JSON.stringify({ 
          error: body.language === 'en' 
            ? 'Software name is too long (maximum 200 characters)' 
            : 'è½¯ä»¶åç§°è¿‡é•¿ï¼ˆæœ€å¤š 200 ä¸ªå­—ç¬¦ï¼‰' 
        }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    // Validate additional info length
    if (body.additionalInfo && body.additionalInfo.length > 5000) {
      return new Response(
        JSON.stringify({ 
          error: body.language === 'en' 
            ? 'Additional information is too long (maximum 5000 characters)' 
            : 'è¡¥å……è¯´æ˜è¿‡é•¿ï¼ˆæœ€å¤š 5000 ä¸ªå­—ç¬¦ï¼‰' 
        }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    // Validate language
    const isEnglish = body.language === 'en';
    if (body.language && body.language !== 'en' && body.language !== 'zh-CN') {
      return new Response(
        JSON.stringify({ 
          error: 'Invalid language parameter' 
        }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    // Check for GitHub token
    if (!env.GITHUB_TOKEN) {
      console.error('GITHUB_TOKEN environment variable is not set');
      return new Response(
        JSON.stringify({ 
          error: body.language === 'en'
            ? 'Server configuration error. Please contact administrator.'
            : 'æœåŠ¡å™¨é…ç½®é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚'
        }),
        { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    const isEnglish = body.language === 'en';
    
    // Prepare issue title and body
    const issueTitle = isEnglish 
      ? `[Software Request] ${body.softwareName}`
      : `[è½¯ä»¶ç”³è¯·] ${body.softwareName}`;
    
    const issueBody = isEnglish 
      ? `## Software Information

**Software Name**: ${body.softwareName}

${body.additionalInfo ? `**Additional Information**: ${body.additionalInfo}` : ''}

---

> This request was automatically generated by a user through the website request form.
> 
> **Processing Workflow**:
> 1. âœ… Request submitted
> 2. ğŸ¤– Waiting for GitHub Copilot Agent to automatically search for software information
> 3. ğŸ“ Agent will create resource files and descriptions following project rules
> 4. ğŸ‘¤ Waiting for admin review
> 5. ğŸ‰ After approval, automatically published to the website

<!-- 
Label: software-request
Do not manually edit this Issue, it will be automatically processed by GitHub Actions.
-->
`
      : `## è½¯ä»¶ä¿¡æ¯

**è½¯ä»¶åç§°**: ${body.softwareName}

${body.additionalInfo ? `**è¡¥å……è¯´æ˜**: ${body.additionalInfo}` : ''}

---

> æ­¤ç”³è¯·ç”±ç”¨æˆ·é€šè¿‡ç½‘ç«™ç”³è¯·è¡¨å•è‡ªåŠ¨ç”Ÿæˆã€‚
> 
> **å¤„ç†æµç¨‹**:
> 1. âœ… ç”³è¯·å·²æäº¤
> 2. ğŸ¤– ç­‰å¾… GitHub Copilot Agent è‡ªåŠ¨æœç´¢è½¯ä»¶ä¿¡æ¯
> 3. ğŸ“ Agent å°†æŒ‰ç…§é¡¹ç›®è§„åˆ™åˆ›å»ºèµ„æºæ–‡ä»¶å’Œæè¿°
> 4. ğŸ‘¤ ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸
> 5. ğŸ‰ å®¡æ ¸é€šè¿‡åè‡ªåŠ¨å‘å¸ƒåˆ°ç½‘ç«™

<!-- 
æ ‡ç­¾: software-request
ä¸è¦æ‰‹åŠ¨ç¼–è¾‘æ­¤ Issueï¼Œå®ƒå°†ç”± GitHub Actions è‡ªåŠ¨å¤„ç†ã€‚
-->
`;

    // Create GitHub issue
    const response = await fetch('https://api.github.com/repos/gmij/soft/issues', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${env.GITHUB_TOKEN}`,
        'Accept': 'application/vnd.github+json',
        'Content-Type': 'application/json',
        'X-GitHub-Api-Version': '2022-11-28',
        'User-Agent': 'Cloudflare-Pages-Function'
      },
      body: JSON.stringify({
        title: issueTitle,
        body: issueBody,
        labels: ['software-request']
      })
    });

    if (!response.ok) {
      const errorData = await response.text();
      console.error('GitHub API error:', response.status, errorData);
      
      return new Response(
        JSON.stringify({ 
          error: body.language === 'en'
            ? 'Failed to create issue. Please try again later or create an issue directly on GitHub.'
            : 'åˆ›å»º Issue å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•æˆ–ç›´æ¥åœ¨ GitHub ä¸Šåˆ›å»º Issueã€‚'
        }),
        { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    const issueData = await response.json() as { number?: number; html_url?: string };

    // Validate response structure
    if (!issueData.number || !issueData.html_url) {
      console.error('Invalid GitHub API response:', issueData);
      return new Response(
        JSON.stringify({ 
          error: body.language === 'en'
            ? 'Unexpected response from GitHub. Please try again later.'
            : 'æ¥è‡ª GitHub çš„å“åº”å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•ã€‚'
        }),
        { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    // Return success response
    return new Response(
      JSON.stringify({
        success: true,
        issueNumber: issueData.number,
        issueUrl: issueData.html_url,
        message: body.language === 'en'
          ? 'Request submitted successfully! Our team will process it soon.'
          : 'ç”³è¯·æäº¤æˆåŠŸï¼æˆ‘ä»¬çš„å›¢é˜Ÿä¼šå°½å¿«å¤„ç†ã€‚'
      }),
      { 
        status: 200, 
        headers: { ...corsHeaders, 'Content-Type': 'application/json' } 
      }
    );

  } catch (error) {
    console.error('Error processing request:', error);
    
    // Don't expose internal error details to client
    return new Response(
      JSON.stringify({ 
        error: 'Internal server error. Please try again later.'
      }),
      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
  }
};
